//
//  Move.m
//  kickboxing app
//
//  Created by Bader on 5/19/20.
//  Copyright Â© 2020 Nebo. All rights reserved.
//

#import "MoveManager.h"

//typedef enum {
//    1 = 1,
//    2 = 2,
//    3 = 3,
//    4 = 4
//} Stance;

@implementation MoveManager : NSObject
//auto generated by compiler
-(id)init {
    self = [super init];
    if(self) {
        self.moveCatList = [[NSMutableArray alloc] init];
        NSMutableArray * normal_kicks = [[NSMutableArray alloc] init];
            {
                [normal_kicks addObject: [[Move alloc] init:@"Round Kick" : 1 : 2 : false : false : false : false]];
                [normal_kicks addObject: [[Move alloc] init:@"Hook Kick" : 2 : 1 : false : false : false : false]];
                [normal_kicks addObject: [[Move alloc] init:@"Frontsweep" : 1 : 2 : false : false : false : false]];
                [normal_kicks addObject: [[Move alloc] init:@"Backsweep" : 2 : 1 : false : false : false : false]];
                [normal_kicks addObject: [[Move alloc] init:@"Touch Down Round" : 1 : 2 : false : false : true : false]];
            }
        NSMutableArray * pop_kicks = [[NSMutableArray alloc] init];
            {
                [pop_kicks addObject: [[Move alloc] init:@"Pop Tornado" : 2 : 2 : false : false : false : false]];
                [pop_kicks addObject: [[Move alloc] init:@"Pop 360" : 2 : 2 : false : false : false : false]];
                [pop_kicks addObject: [[Move alloc] init:@"Backside 900" : 4 : 2 : false : false : false : false]];
                [pop_kicks addObject: [[Move alloc] init:@"Pop 720 Hook" : 2 : 1 : false : false : false : false]];
            }
        NSMutableArray * cheat_kicks = [[NSMutableArray alloc] init];
            {
                [cheat_kicks addObject: [[Move alloc] init:@"Tornado" : 2 : 2 : false : true : false : false]];
                [cheat_kicks addObject: [[Move alloc] init:@"Parafuso" : 2 : 4 : false : false : true : false]];
                [cheat_kicks addObject: [[Move alloc] init:@"540" : 2 : 1 : false : false : false : false]];
                [cheat_kicks addObject: [[Move alloc] init:@"Cheat 720" : 2 : 1 : false : false : false : false]];
                [cheat_kicks addObject: [[Move alloc] init:@"Jack Knife" : 2 : 1 : false : false : false : false]];
                [cheat_kicks addObject: [[Move alloc] init:@"Cheat 900" : 2 : 2 : false : false : false : false]];
            }
        NSMutableArray * swing_kicks = [[NSMutableArray alloc] init];
            {
                [swing_kicks addObject: [[Move alloc] init:@"Skip Hook" : 1 : 1 : false : false : false : false]];
            }
        NSMutableArray * flat_spins = [[NSMutableArray alloc] init];
            {
                [flat_spins addObject: [[Move alloc] init:@"Butterfly Kick" : 1 : 1 : false : false : false : false]];
                [flat_spins addObject: [[Move alloc] init:@"Butter Knife" : 1 : 1 : false : false : false : false]];
                [flat_spins addObject: [[Move alloc] init:@"Machine" : 1 : 4 : false : true : false : false]];
                [flat_spins addObject: [[Move alloc] init:@"Spider" : 1 : 4 : false : true : false : false]];
            }
        NSMutableArray * flat_twists = [[NSMutableArray alloc] init];
            {
                [flat_twists addObject: [[Move alloc] init:@"Btwist" : 1 : 4 : false : true : false : false]];
                [flat_twists addObject: [[Move alloc] init:@"Btwist Round" : 1 : 2 : false : false : false : false]];
                [flat_twists addObject: [[Move alloc] init:@"Btwist Hyper Hook" : 1 : 1 : false : false : false : false]];
            }
        NSMutableArray * backward_flips = [[NSMutableArray alloc] init];
            {
                [backward_flips addObject: [[Move alloc] init:@"Back Hand Spring" : 4 : 4 : false : false : true : false]];
                [backward_flips addObject: [[Move alloc] init:@"Back Tuck" : 4 : 4 : false : false : false : true]];
                [backward_flips addObject: [[Move alloc] init:@"Flash Kick" : 4 : 1 : false : false : false : true]];
                [backward_flips addObject: [[Move alloc] init:@"Arabian" : 4 : 3 : false : false : false : true]];
                [backward_flips addObject: [[Move alloc] init:@"Gainer Tuck" : 3 : 3 : true : false : false : false]];
                [backward_flips addObject: [[Move alloc] init:@"Cheat Gainer" : 4 : 1 : true : false : false : false]];
                [backward_flips addObject: [[Move alloc] init:@"Gainer Switch" : 4 : 4 : true : true : false : false]];
                [backward_flips addObject: [[Move alloc] init:@"Moon Kick" : 4 : 3 : true : false : false : false]];
            }
        NSMutableArray * backward_twists = [[NSMutableArray alloc] init];
            {
                [backward_twists addObject: [[Move alloc] init:@"Full" : 4 : 4 : false : false : false : true]];
                [backward_twists addObject: [[Move alloc] init:@"Corkscrew" : 4 : 4 : true : true : false : false]];
                [backward_twists addObject: [[Move alloc] init:@"Boxcutter" : 4 : 1 : true : false : false : false]];
            }
        NSMutableArray * forward_flips = [[NSMutableArray alloc] init];
            {
                [forward_flips addObject: [[Move alloc] init:@"Dive Roll" : 3 : 3 : false : false : false : false]];
                [forward_flips addObject: [[Move alloc] init:@"Reversao" : 3 : 3 : false : false : true : false]];
                [forward_flips addObject: [[Move alloc] init:@"Front Tuck" : 3 : 3 : false : false : false : true]];
                [forward_flips addObject: [[Move alloc] init:@"Webster" : 3 : 3 : false : false : false : false]];
            }
        NSMutableArray * forward_twists = [[NSMutableArray alloc] init];
        {
            [forward_twists addObject: [[Move alloc] init:@"360 Dive Roll" : 3 : 3 : false : false : false : false]];
        }
        NSMutableArray * outside_flips = [[NSMutableArray alloc] init];
        {
//            [outside_flips addObject: [[Move alloc] init:@"Dleg" : 2 : 4 : false : false]];
            [outside_flips addObject: [[Move alloc] init:@"Gumbi" : 1 : 4 : false : true : false : false]];
            [outside_flips addObject: [[Move alloc] init:@"Raiz" : 1 : 4 : false : true : false : false]];
            [outside_flips addObject: [[Move alloc] init:@"TDR" : 1 : 4 : false : true : true : false]];
        }
        NSMutableArray * outside_twists = [[NSMutableArray alloc] init];
        {
            [outside_twists addObject: [[Move alloc] init:@"Sideswipe" : 1 : 1 : false : false : false : false]];
        }
        NSMutableArray * inside_tricks = [[NSMutableArray alloc] init];
        {
            [inside_tricks addObject: [[Move alloc] init:@"Sideflip" : 1 : 1 : false : false : false : false]];
            [inside_tricks addObject: [[Move alloc] init:@"Frisbee" : 1 : 1 : false : false : false : false]];
            [inside_tricks addObject: [[Move alloc] init:@"Cartwheel" : 1 : 1 : false : false : false : false]];
//            [inside_tricks addObject: [[Move alloc] init:@"Roundoff" : 3 : 4 : false : false : true : false]];
            [inside_tricks addObject: [[Move alloc] init:@"Helicoptero" : 1 : 3 : false : false : false : false]];
            [inside_tricks addObject: [[Move alloc] init:@"Aerial" : 1 : 1 : false : false : false : false]];
            [inside_tricks addObject: [[Move alloc] init:@"Aerial Hook" : 1 : 1 : false : false : false : false]];
            [inside_tricks addObject: [[Move alloc] init:@"Scoot" : 1 : 4 : false : true : true : false]];
            [inside_tricks addObject: [[Move alloc] init:@"Master Scoot" : 1 : 4 : false : true : true : false]];
        }

//        [_moveCatList setObject: normal_kicks forKey:@"normal_kicks"];
//        [_moveCatList setObject: pop_kicks forKey:@"pop_kicks"];
//        [_moveCatList setObject: cheat_kicks forKey:@"cheat_kicks"];
//        [_moveCatList setObject: swing_kicks forKey:@"swing_kicks"];
//        [_moveCatList setObject: flat_spins forKey:@"flat_spins"];
//        [_moveCatList setObject: flat_twists forKey:@"flat_twists"];
//        [_moveCatList setObject: backward_flips forKey:@"backward_flips"];
//        [_moveCatList setObject: backward_twists forKey:@"backward_twists"];
//        [_moveCatList setObject: forward_flips forKey:@"forward_flips"];
//        [_moveCatList setObject: forward_twists forKey:@"forward_twists"];
//        [_moveCatList setObject: outside_flips forKey:@"outside_flips"];
//        [_moveCatList setObject: outside_twists forKey:@"outside_twists"];
//        [_moveCatList setObject: inside_tricks forKey:@"inside_tricks"];
        
//        [_moveCatList setObject: normal_kicks forKey:@"Normal Kicks"];
//        [_moveCatList setObject: pop_kicks forKey:@"Pop Kicks"];
//        [_moveCatList setObject: cheat_kicks forKey:@"Cheat Kicks"];
//        [_moveCatList setObject: swing_kicks forKey:@"Swing Kicks"];
//        [_moveCatList setObject: flat_spins forKey:@"Flat Spins"];
//        [_moveCatList setObject: flat_twists forKey:@"Flat Twists"];
//        [_moveCatList setObject: backward_flips forKey:@"Backward Flips"];
//        [_moveCatList setObject: backward_twists forKey:@"Backward Twists"];
//        [_moveCatList setObject: forward_flips forKey:@"Forward Flips"];
//        [_moveCatList setObject: forward_twists forKey:@"Forward Twists"];
//        [_moveCatList setObject: outside_flips forKey:@"Outside Flips"];
//        [_moveCatList setObject: outside_twists forKey:@"Outside Twists"];
//        [_moveCatList setObject: inside_tricks forKey:@"Inside Tricks"];
        
        [_moveCatList addObject: normal_kicks];
        [_moveCatList addObject: pop_kicks];
        [_moveCatList addObject: cheat_kicks];
        [_moveCatList addObject: swing_kicks];
        [_moveCatList addObject: flat_spins];
        [_moveCatList addObject: flat_twists];
        [_moveCatList addObject: backward_flips];
        [_moveCatList addObject: backward_twists];
        [_moveCatList addObject: forward_flips];
        [_moveCatList addObject: forward_twists];
        [_moveCatList addObject: outside_flips];
        [_moveCatList addObject: outside_twists];
        [_moveCatList addObject: inside_tricks];
        
        self.moveList = [[NSMutableArray alloc] init];
        for(int i = 0; i < self.moveCatList.count; i++) {
            for(int n = 0; n < [(NSMutableArray *) self.moveCatList[i] count]; n++) {
                [_moveList addObject: (Move *) [(NSMutableArray *) self.moveCatList[i] objectAtIndex:n] ];
            }
        }
    }
    return self;
}
-(NSMutableArray *)generate: (int) size {
    NSMutableArray * rv = [[NSMutableArray alloc] init];
    
    Move * current = [self randomMove: [self getActiveMoveList]];
    [rv addObject: current];
    
    for(int i = 0; i < size - 1; i++) {
        current = [self getNextMoveHelper: current];
        [rv addObject: current];
    }
    [self printMoveArray: rv];
    return rv;
}

-(Move *) getNextMoveHelper: (Move *) old {
    NSMutableArray * temp_move_list = [[NSMutableArray alloc] init];
    NSMutableArray * activeMoveList = [self getActiveMoveList];
    WeightObject * obj;
    int highestScore = 0;
    for(int i = 0; i < activeMoveList.count; i++) {
        obj = [[WeightObject alloc] init: 1 : (Move *) activeMoveList[i]];
        //check for repeating move
        if(old == obj.move)
            obj.weight -= 1;
        
        //check matching stance
        if(old.landing_stance == obj.move.take_off_stance)
            obj.weight += 3;
            
        //check compatible stances
        switch(old.landing_stance) {
            case 1: //old move ends in 1
                if(obj.move.take_off_stance == 3)//forward tricks are compatable
                    obj.weight += 2;
                break;
            case 2: //old move ends in 1
                if(obj.move.take_off_stance == 4)//forward tricks are compatable
                    obj.weight += 2;
                break;
            case 3: //old move ends in 1
                if(obj.move.take_off_stance == 2)//forward tricks are compatable
                    obj.weight += 3;
                break;
            case 4: //old move ends in 1
                if(obj.move.take_off_stance == 1)//forward tricks are compatable
                    obj.weight += 2;
                break;
        }
        
        //check swing compatability
        if(old.landing_can_swing && obj.move.take_off_swing) {
            obj.weight += 3;
        } else if (!old.landing_can_swing && !obj.move.take_off_swing) {
            obj.weight += 3;
        }
        
        //adds the move to moveList
        [temp_move_list addObject:obj];
        
        if(obj.weight > highestScore)
            highestScore = obj.weight;
    }
    
    //select move
    NSMutableArray * highestMoves = [[NSMutableArray alloc] init];
    WeightObject * n;
    //add heighest weighted moves
    for(int i = 0; i < temp_move_list.count; i++) {
        n = (WeightObject *) temp_move_list[i];
        if(n.weight == highestScore)
            [highestMoves addObject: n.move];
    }
    //add second heighest weighted moves for variance
    int variance = 0;
    for(int i = 0; i < temp_move_list.count; i++) {
        n = (WeightObject *) temp_move_list[i];
        if(n.weight >= highestScore - variance)
            [highestMoves addObject: n.move];
    }
        
    return [self randomMove: highestMoves];
}

-(Move *) randomMove: (NSMutableArray *) array {
    int r = arc4random_uniform(array.count);
    return (Move *) array[r];
}

-(NSMutableArray *) getActiveMoveList {
    NSMutableArray * activeMoves = [[NSMutableArray alloc] init];
    Move * current;
    for(int i = 0; i < self.moveList.count; i++) {
        current = (Move *) self.moveList[i];
        if([current isActive]) {
            [activeMoves addObject: current];
        }
    }
    return activeMoves;
}

-(void) printMoveArray: (NSMutableArray *) array {
    Move * current;
    for(int i = 0; i < array.count; i++) {
        current = (Move *) array[i];
        NSLog(@"%@", [current name]);
    }
    NSLog(@"--------------------------");
}

@end
